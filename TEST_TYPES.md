# 테스트 시스템 구분: 스테이지 vs 마스터리 레벨업

> 두 시스템은 독립적으로 동작하며 목적이 다름.

---

## 1. 스테이지 테스트 (개별 단어 숙달)

### 목적
특정 단어를 **반복 학습**하여 완전 숙달(mastered)까지 도달시키는 것.

### 핵심 메카닉
- 각 단어가 **Stage 1 → 2 → 3 → 4 → 5 → Mastered** 순서로 진행
- 스테이지에 따라 **문제 유형이 자동 결정**됨
- 연속 정답(streak)을 충족하면 다음 스테이지로 승급
- 오답 시 이전 스테이지로 강등

### 스테이지별 문제 유형

| Stage | 문제 유형 | 타이머 | 설명 |
|-------|----------|--------|------|
| 1 | word_to_meaning | 5초 | 영어 단어 → 한국어 뜻 선택 |
| 2 | meaning_to_word | 5초 | 한국어 뜻 → 영어 단어 선택 |
| 3 | listen_and_type | 15초 | 발음 듣고 영어 타이핑 |
| 4 | listen_to_meaning | 10초 | 발음 듣고 한국어 뜻 선택 |
| 5 | meaning_and_type | 15초 | 한국어 뜻 보고 영어 타이핑 |

### 승급 조건 (required_streak)

| 단어 레벨 | 필요 연속 정답 |
|-----------|---------------|
| 현재 설정 | 1회 (즉시 승급) |

### 데이터 모델
```
word_mastery
├── stage: 1-5 (현재 스테이지)
├── stage_streak: 연속 정답 횟수
├── total_attempts: 총 시도
├── total_correct: 총 정답
├── mastered_at: 마스터 완료 시점
└── review_due_at: SRS 복습 예정일 (3/7/30일)
```

### SRS 복습
- Stage 5 통과 → mastered 상태
- 복습 간격: 3일 → 7일 → 30일
- 복습 시점 도래 시 Stage 3으로 복귀

### 사용 시나리오
- 장기간 단어 학습 (수업 후 숙제)
- 특정 교재/레슨 범위의 단어 암기
- 반복 학습으로 완전 숙달 목표

---

## 2. 마스터리 레벨업 테스트 (XP 기반 레벨 판정)

### 목적
학생의 **영어 어휘 수준을 실시간으로 판정**하는 것. (배치테스트/레벨테스트)

### 핵심 메카닉
- **XP 기반 레벨 진행**: 정답 → XP 획득 → 레슨 클리어 → 교재 레벨업
- RPG 방식: "레벨1 몬스터 사냥 → 경험치 → 레벨업 → 레벨2 몬스터 도전"
- **50~100문항 단일 플로우** (중간 전환 없음)
- 프론트엔드에서 XP 계산, 실시간 레벨 변동
- 문제 유형은 단어의 내부 스테이지로 자동 결정 (사용자 비공개)

### 레벨 구조
```
15개 교재 (Level 1~15)
├── 각 교재 = 25 레슨
├── 서브레벨: "교재-레슨" (예: "1-1", "3-12", "7-25")
└── 랭크 매핑: 1=Iron, 2=Bronze, 3=Silver, ..., 10=Challenger
```

### XP 메카닉스

#### 획득/차감
| 상황 | XP 변동 |
|------|---------|
| 현재 레벨 정답 | +8 + book*2 (기본) |
| 속도 보너스 (1초 이내) | +5 |
| 속도 보너스 (2초 이내) | +4 |
| 속도 보너스 (3초 이내) | +3 |
| 낮은 레벨 정답 | +max(4, book) |
| 콤보 3~4 | +1 |
| 콤보 5~9 | +2 |
| 콤보 10~14 | +3 |
| 콤보 15~19 | +4 |
| 콤보 20+ | +5 |
| 오답 | -(3 + book) |
| 연속 2회 오답 | -(5 + book) |
| 연속 3회+ 오답 | -(8 + book) |

#### 레슨당 필요 XP
```typescript
getLessonXp(book) = 2 + book
// Book 1: 3, Book 2: 4, ..., Book 10: 12, Book 15: 17
```

#### 레벨업/다운 조건
- **레벨업**: 레슨 XP 달성 → 다음 레슨 (25레슨 클리어 → 다음 교재)
- **레벨다운**: XP < 0 → 이전 레슨 (XP = 이전 레슨의 80%에서 재시작)
- **바닥**: Level 1-1에서 XP = max(0, xp)

### 문제 풀(Pool) 시스템
```
세션 시작 시:
  현재 레벨 ~ +4레벨, 각 10문항 = 최대 50문항 프리로드

레벨 전환 시:
  이미 로드된 풀로 즉시 전환

풀 소진 시:
  POST /mastery/batch → 해당 레벨 10문항 lazy fetch
```

### 데이터 모델
```
learning_sessions
├── current_level: 적응형 레벨 (1-15)
├── words_practiced: 총 연습 문항 수
├── words_advanced: 정답 수
├── words_demoted: 오답 수
├── best_combo: 최고 콤보
└── completed_at: 완료 시점

[프론트엔드 상태]
├── xp: 현재 레슨 누적 XP
├── currentBook: 현재 교재 (1-15)
├── currentLesson: 현재 레슨 (1-25)
├── combo / bestCombo
├── correctCount / totalAnswered
└── consecutiveWrong
```

### API 흐름
```
POST /mastery/start-by-code  → 세션 시작 + 멀티레벨 풀
POST /mastery/{id}/answer    → 답안 제출 (내부 스테이지 처리)
POST /mastery/batch          → 추가 문항 lazy loading
POST /mastery/complete-batch → final_level 저장
```

### 사용 시나리오
- 신규 학생 배치테스트 (레벨 판정)
- 정기 레벨 평가
- 실력 변화 추적

---

## 3. 두 시스템의 관계

```
┌─────────────────────────────────────────────────────┐
│           마스터리 레벨업 테스트 (외부)                │
│                                                     │
│   XP 획득 → 레슨 클리어 → 교재 레벨업               │
│   (프론트엔드 실시간 계산)                            │
│                                                     │
│   ┌─────────────────────────────────────────────┐   │
│   │      스테이지 시스템 (내부, 비공개)            │   │
│   │                                             │   │
│   │   word_mastery.stage → 문제 유형 결정        │   │
│   │   Stage 1-2: 선택형 (쉬움, 5초)              │   │
│   │   Stage 3: 듣고 타이핑 (중간, 15초)           │   │
│   │   Stage 4: 듣고 선택 (중상, 10초)             │   │
│   │   Stage 5: 뜻 보고 타이핑 (어려움, 15초)      │   │
│   └─────────────────────────────────────────────┘   │
│                                                     │
│   레벨업 시스템은 스테이지에 의존하지 않음.            │
│   스테이지는 문제 유형 결정에만 사용됨.               │
└─────────────────────────────────────────────────────┘
```

### 핵심 구분

| 항목 | 스테이지 테스트 | 마스터리 레벨업 |
|------|----------------|----------------|
| **목적** | 단어 숙달 (학습) | 레벨 판정 (평가) |
| **대상** | 개별 단어 | 학생 전체 수준 |
| **진행 단위** | Stage 1→5→Mastered | XP → Lesson → Book |
| **세션 길이** | 무제한 (반복) | 50~100문항 |
| **사용자 인지** | 스테이지 비공개 | 레벨/랭크 실시간 표시 |
| **DB 필드** | word_mastery.stage | learning_sessions.current_level |
| **계산 위치** | 백엔드 (submit_answer) | 프론트엔드 (masteryStore) |
| **assignment_type** | mastery | mastery |
| **test_type** | - | placement / periodic |

---

## 4. 현재 TEST0213 설정

```
Config Name   : 전체 교재 레벨업 배치고사 (Lv1-15, 100Q)
Test Type     : placement
Questions     : 100
Level Range   : 1 ~ 15 (전체 교재)
Total Time    : 600s
Status        : pending
Total Words   : 11,129개
```

*Last updated: 2026-02-12*